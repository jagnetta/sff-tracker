<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Print Route Details - Taunton Food Drive</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        /* Print-optimized styles */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #e0e0e0;
            background-color: #1a1a1a;
            margin: 0;
            padding: 20px;
        }
        
        .print-container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        
        /* Print-efficient layout styles */
        .print-efficient-container {
            max-width: 100%;
            margin: 0;
            padding: 0;
        }
        
        .compact-header {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        
        .compact-info {
            color: #e0e0e0;
            font-size: 0.9em;
            line-height: 1.3;
        }
        
        .route-list {
            margin-bottom: 15px;
        }
        
        .route-item {
            background: #2d2d2d;
            margin-bottom: 8px;
            padding: 8px;
            border-radius: 4px;
            width: 100%;
        }
        
        .route-table {
            width: 100%;
            border-collapse: collapse;
            table-layout: fixed;
        }
        
        .route-qr-cell {
            width: 110px;
            vertical-align: middle;
            padding-right: 10px;
            text-align: center;
        }
        
        .route-info-cell {
            vertical-align: top;
        }
        
        .route-qr-code {
            display: block;
        }
        
        .route-info {
            width: 100%;
        }
        
        .route-header {
            font-weight: bold;
            color: #4a9eff;
            margin-bottom: 4px;
            font-size: 0.95em;
        }
        
        .route-description {
            font-size: 0.85em;
            line-height: 1.3;
            color: #e0e0e0;
        }
        
        .compact-instructions {
            background: #2d2d2d;
            padding: 10px;
            border-radius: 4px;
            font-size: 0.8em;
            line-height: 1.4;
        }
        
        .instruction-line {
            margin-bottom: 4px;
            color: #e0e0e0;
        }
        
        .instruction-line:last-child {
            margin-bottom: 0;
        }
        
        
        @media print {
            * {
                -webkit-print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            
            body {
                background: white !important;
                color: black !important;
                padding: 0 !important;
                margin: 0 !important;
                font-size: 16pt !important;
                line-height: 1.4 !important;
                height: auto !important;
                min-height: 0 !important;
            }
            
            .print-container {
                max-width: none !important;
                margin: 0 !important;
                padding: 10px !important;
                height: auto !important;
                min-height: 0 !important;
            }
            
            .print-efficient-container {
                margin: 0 !important;
                padding: 0 !important;
                height: auto !important;
                min-height: 0 !important;
                page-break-after: avoid !important;
            }
            
            html {
                height: auto !important;
                min-height: 0 !important;
            }
            
            .compact-header {
                background: #f8f9fa !important;
                border: 1px solid #ddd !important;
                padding: 10px !important;
                margin-bottom: 12px !important;
                page-break-inside: avoid;
            }
            
            .compact-info {
                color: black !important;
                font-size: 15pt !important;
                line-height: 1.4 !important;
            }
            
            .route-list {
                margin-bottom: 12px !important;
                page-break-after: avoid !important;
            }
            
            .route-item {
                background: white !important;
                border: 1px solid #ccc !important;
                margin-bottom: 8px !important;
                padding: 8px !important;
                page-break-inside: avoid;
                width: 100% !important;
            }
            
            .route-table {
                width: 100% !important;
                border-collapse: collapse !important;
                table-layout: fixed !important;
            }
            
            .route-qr-cell {
                width: 110px !important;
                vertical-align: middle !important;
                padding-right: 8px !important;
                text-align: center !important;
            }
            
            .route-info-cell {
                vertical-align: top !important;
            }
            
            .route-qr-code {
                display: block !important;
            }
            
            .route-info {
                width: 100% !important;
            }
            
            .route-header {
                color: black !important;
                font-size: 15pt !important;
                font-weight: bold !important;
                margin-bottom: 2px !important;
            }
            
            .route-description {
                color: black !important;
                font-size: 14pt !important;
                line-height: 1.4 !important;
            }
            
            .compact-instructions {
                background: #f8f9fa !important;
                border: 1px solid #ddd !important;
                padding: 10px !important;
                font-size: 14pt !important;
                line-height: 1.4 !important;
                page-break-inside: avoid !important;
                page-break-after: avoid !important;
                margin-bottom: 0 !important;
                margin-top: 8px !important;
            }
            
            .instruction-line {
                color: black !important;
                margin-bottom: 2px !important;
            }
            
            .instruction-line:last-child {
                margin-bottom: 0 !important;
            }
            
            .route-qr-code canvas,
            .route-qr-code img {
                border: 1px solid #000 !important;
                display: block !important;
                visibility: visible !important;
                opacity: 1 !important;
            }
            
            /* Prevent extra pages and ensure content ends properly */
            main {
                page-break-after: avoid !important;
                overflow: hidden !important;
            }
            
            .print-container::after,
            main::after,
            .print-efficient-container::after {
                content: "" !important;
                display: block !important;
                height: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
                page-break-after: avoid !important;
            }
            
        }
        
        /* QR Code Progress Meter */
        .qr-progress-container {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            border: 1px solid #4a9eff;
            border-radius: 8px;
            padding: 15px;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            min-width: 300px;
        }
        
        .qr-progress-content {
            text-align: center;
        }
        
        .qr-progress-text {
            color: #e0e0e0;
            font-size: 0.9em;
            margin-bottom: 8px;
            font-weight: 500;
        }
        
        .qr-progress-bar {
            width: 100%;
            height: 8px;
            background: #1a1a1a;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }
        
        .qr-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4a9eff, #74b9ff);
            border-radius: 4px;
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .qr-progress-count {
            color: #b0b0b0;
            font-size: 0.8em;
        }
        
        @media print {
            .qr-progress-container {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <div class="print-container">

        <main>
            <div class="print-efficient-container">
                <!-- Compact Header with all key info in one line -->
                <div class="compact-header">
                    <div id="compactInfo" class="compact-info">
                        <!-- Compact info will be populated by JavaScript -->
                    </div>
                </div>

                <!-- Important Information - moved to position 2 -->
                <div class="compact-instructions">
                    <div class="instruction-line">
                        <strong>Dates:</strong> Door Hangers Oct 25-26 (9AM-3PM) • Food Pickup Nov 1 (9AM-1PM)
                    </div>
                    <div class="instruction-line">
                        <strong>Drop Off:</strong> Matthew Mission Food Pantry, 76 Church Green, Taunton, MA 02780
                    </div>
                    <div class="instruction-line">
                        <strong>Route Notes:</strong> Pay attention to odd/even numbers and cross streets. "All" means both sides of street.
                    </div>
                </div>

                <!-- Route Details - Most important content -->
                <div id="routeDetails" class="route-list">
                    <!-- Route details will be populated by JavaScript -->
                </div>
            </div>
        </main>

        <!-- QR Code Generation Progress -->
        <div id="qrProgress" class="qr-progress-container" style="display: none;">
            <div class="qr-progress-content">
                <div class="qr-progress-text">Generating QR codes for maps...</div>
                <div class="qr-progress-bar">
                    <div id="qrProgressBar" class="qr-progress-fill"></div>
                </div>
                <div id="qrProgressCount" class="qr-progress-count">0 / 0</div>
            </div>
        </div>

    </div>

    <script src="data.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <script>
        // Same generateGoogleMapsUrl function as the main app
        function generateGoogleMapsUrl(route) {
            const description = route.description;
            const segments = description.split(/ - All(?:\s*\/\/|$)/).map(s => s.trim()).filter(s => s.length > 0);
            
            if (segments.length === 0) {
                return `https://www.google.com/maps/search/${encodeURIComponent(route.name + ' Taunton MA')}`;
            }
            
            let waypoints = [];
            segments.forEach(segment => {
                let cleanSegment = segment.replace(/\([^)]+\)/g, '').trim();
                waypoints.push(encodeURIComponent(cleanSegment + ', Taunton, MA'));
            });
            
            if (waypoints.length === 1) {
                return `https://www.google.com/maps/search/${waypoints[0]}`;
            } else {
                const origin = waypoints[0];
                const destination = waypoints[waypoints.length - 1];
                const intermediate = waypoints.slice(1, -1);
                
                let url = `https://www.google.com/maps/dir/${origin}`;
                
                if (intermediate.length > 0) {
                    url += '/' + intermediate.join('/');
                }
                
                if (waypoints.length > 1) {
                    url += '/' + destination;
                }
                
                return url;
            }
        }

        // URL shortener function using TinyURL API
        async function shortenUrl(longUrl) {
            try {
                const response = await fetch(`https://tinyurl.com/api-create.php?url=${encodeURIComponent(longUrl)}`);
                const shortUrl = await response.text();
                
                // Check if we got a valid TinyURL response
                if (shortUrl.startsWith('https://tinyurl.com/')) {
                    return shortUrl;
                } else {
                    console.warn('URL shortening failed, using original URL');
                    return longUrl;
                }
            } catch (error) {
                console.warn('URL shortening error:', error);
                return longUrl; // Fallback to original URL
            }
        }

        // Display route details
        function displayRouteDetails(routes) {
            const routeDetails = document.getElementById('routeDetails');
            
            if (!routes || routes.length === 0) {
                routeDetails.innerHTML = '<p>No route details available.</p>';
                return;
            }
            
            const detailsHTML = routes.map((route, index) => {
                const qrId = `qr-${route.routeId}-${index}`;
                
                return `
                <div class="route-item">
                    <table class="route-table">
                        <tr>
                            <td class="route-qr-cell">
                                <div class="route-qr-code">
                                    <canvas id="${qrId}" width="100" height="100"></canvas>
                                </div>
                            </td>
                            <td class="route-info-cell">
                                <div class="route-info">
                                    <div class="route-header">Route ${route.routeId} - ${route.name} (${route.flyerCount} flyers)</div>
                                    <div class="route-description">${route.description}</div>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                `;
            }).join('');
            
            routeDetails.innerHTML = detailsHTML;
            
            // Generate QR codes asynchronously
            generateQRCodes(routes);
        }
        
        // Update progress meter
        function updateProgress(current, total, text = 'Generating QR codes for maps...') {
            const progressContainer = document.getElementById('qrProgress');
            const progressBar = document.getElementById('qrProgressBar');
            const progressCount = document.getElementById('qrProgressCount');
            const progressText = progressContainer.querySelector('.qr-progress-text');
            
            if (total > 0) {
                progressContainer.style.display = 'block';
                progressText.textContent = text;
                progressCount.textContent = `${current} / ${total}`;
                const percentage = (current / total) * 100;
                progressBar.style.width = `${percentage}%`;
            } else {
                progressContainer.style.display = 'none';
            }
        }
        
        // Hide progress meter
        function hideProgress() {
            const progressContainer = document.getElementById('qrProgress');
            progressContainer.style.display = 'none';
        }
        
        // Generate QR codes with URL shortening
        async function generateQRCodes(routes) {
            if (!routes || routes.length === 0) {
                window.qrCodesReady = true;
                return;
            }
            
            console.log(`Generating QR codes for ${routes.length} routes...`);
            window.qrCodesReady = false; // Reset flag
            
            // Show initial progress
            updateProgress(0, routes.length);
            
            // Check if QRCode library is available
            if (typeof QRCode === 'undefined') {
                console.log('QRCode library not available, using fallback API method');
                // Fallback to external API method with URL shortening
                for (let index = 0; index < routes.length; index++) {
                    const route = routes[index];
                    console.log(`Processing route ${index + 1}/${routes.length}: ${route.routeId}`);
                    
                    // Update progress
                    updateProgress(index + 1, routes.length, `Processing route ${index + 1} of ${routes.length}...`);
                    
                    const longUrl = generateGoogleMapsUrl(route);
                    const shortUrl = await shortenUrl(longUrl);
                    const qrId = `qr-${route.routeId}-${index}`;
                    const canvas = document.getElementById(qrId);
                    const qrApiUrl = `https://api.qrserver.com/v1/create-qr-code/?size=100x100&format=png&data=${encodeURIComponent(shortUrl)}`;
                    
                    if (canvas) {
                        // Replace canvas with img element for fallback
                        const img = document.createElement('img');
                        img.src = qrApiUrl;
                        img.width = 100;
                        img.height = 100;
                        img.alt = 'QR Code for Route Map';
                        canvas.parentNode.replaceChild(img, canvas);
                    }
                }
                console.log('All QR codes processed (API method)');
                hideProgress(); // Hide progress when complete
                window.qrCodesReady = true; // Set ready flag after all are processed
                return;
            }
            
            // Generate QR codes using client-side library with URL shortening
            for (let index = 0; index < routes.length; index++) {
                const route = routes[index];
                console.log(`Processing route ${index + 1}/${routes.length}: ${route.routeId}`);
                
                // Update progress
                updateProgress(index + 1, routes.length, `Processing route ${index + 1} of ${routes.length}...`);
                
                const longUrl = generateGoogleMapsUrl(route);
                const shortUrl = await shortenUrl(longUrl);
                const qrId = `qr-${route.routeId}-${index}`;
                const canvas = document.getElementById(qrId);
                
                if (canvas) {
                    QRCode.toCanvas(canvas, shortUrl, {
                        width: 100,
                        height: 100,
                        margin: 1,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        }
                    }, function (error) {
                        if (error) console.error('QR Code generation error:', error);
                    });
                }
            }
            console.log('All QR codes processed (client-side method)');
            hideProgress(); // Hide progress when complete
            window.qrCodesReady = true; // Set ready flag after all are processed
        }

        // Display compact information
        function displayCompactInfo(routes, userInfo) {
            const compactInfo = document.getElementById('compactInfo');
            const totalFlyers = routes.reduce((sum, route) => sum + route.flyerCount, 0);
            const routeCount = routes.length;
            
            // Determine which regions the routes are from
            const routesByRegion = {};
            routes.forEach(route => {
                // Find which region this route belongs to
                for (const regionName in routeData) {
                    if (routeData[regionName].find(r => r.routeId === route.routeId)) {
                        if (!routesByRegion[regionName]) {
                            routesByRegion[regionName] = 0;
                        }
                        routesByRegion[regionName]++;
                        break;
                    }
                }
            });
            
            // Create region display text
            const regionNames = Object.keys(routesByRegion);
            let regionText;
            if (regionNames.length === 1) {
                regionText = `${regionNames[0]} Region`;
            } else {
                regionText = `${regionNames.join(', ')} Regions`;
            }
            
            compactInfo.innerHTML = `
                <strong>${userInfo.lastName}</strong> • ${userInfo.unit} • ${regionText} • ${routeCount} ${routeCount === 1 ? 'Route' : 'Routes'} • ${totalFlyers.toLocaleString()} Flyers • ${new Date().toLocaleDateString()}
            `;
        }

        // Auto-print function that waits for QR codes
        function autoPrint() {
            console.log('Auto-print initiated, waiting for QR codes...');
            let printTriggered = false; // Flag to ensure print only happens once
            
            // Check if QR codes are ready
            const checkReady = setInterval(() => {
                if (window.qrCodesReady && !printTriggered) {
                    printTriggered = true;
                    clearInterval(checkReady);
                    console.log('QR codes ready, opening print dialog');
                    setTimeout(() => {
                        window.print();
                    }, 500); // Small additional delay to ensure rendering is complete
                }
            }, 100);
            
            // Timeout fallback (in case something goes wrong)
            setTimeout(() => {
                if (!printTriggered) {
                    printTriggered = true;
                    clearInterval(checkReady);
                    console.log('Timeout reached, printing anyway');
                    window.print();
                }
            }, 15000); // 15 second timeout for URL shortening
        }

        // Load data from URL parameters or sessionStorage
        document.addEventListener('DOMContentLoaded', function() {
            try {
                console.log('Print page loading...');
                console.log('routeData available:', typeof routeData !== 'undefined');
                
                // Get data from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const selectedRegion = urlParams.get('region');
                const selectedRouteIds = urlParams.get('routes') ? JSON.parse(decodeURIComponent(urlParams.get('routes'))) : [];
                const userInfo = urlParams.get('user') ? JSON.parse(decodeURIComponent(urlParams.get('user'))) : null;
                
                console.log('URL params - region:', selectedRegion, 'routes:', selectedRouteIds, 'user:', userInfo);
                
                // Fallback to sessionStorage if URL params not available
                const region = selectedRegion || sessionStorage.getItem('selectedRegion');
                const routeIds = selectedRouteIds.length > 0 ? selectedRouteIds : JSON.parse(sessionStorage.getItem('selectedRoutes') || '[]');
                const user = userInfo || JSON.parse(sessionStorage.getItem('userInfo') || '{}');
                
                console.log('Final data - region:', region, 'routeIds:', routeIds, 'user:', user);
                
                if (!region || routeIds.length === 0) {
                    console.log('Missing required data - region:', region, 'routeIds length:', routeIds.length);
                    document.querySelector('main').innerHTML = '<div class="user-assignment-info"><h4>Error</h4><p>No route data found. Please select routes first.</p></div>';
                    return;
                }
                
                // Check if routeData is available
                if (typeof routeData === 'undefined') {
                    console.error('routeData is undefined');
                    document.querySelector('main').innerHTML = '<div class="user-assignment-info"><h4>Error</h4><p>Route data not loaded. Please try refreshing the page.</p></div>';
                    return;
                }
                
                // Get route data for selected routes from ALL regions (users can have routes from multiple regions)
                const selectedRoutes = [];
                routeIds.forEach(routeId => {
                    // Search across all regions for each route
                    for (const regionName in routeData) {
                        const route = routeData[regionName].find(r => r.routeId === routeId);
                        if (route) {
                            selectedRoutes.push(route);
                            break; // Found the route, no need to check other regions
                        }
                    }
                });
                console.log('Found routes across all regions:', selectedRoutes.length);
                
                if (selectedRoutes.length === 0) {
                    console.log('No routes found matching the selected IDs');
                    document.querySelector('main').innerHTML = '<div class="user-assignment-info"><h4>Error</h4><p>Selected routes not found in data.</p></div>';
                    return;
                }
                
                // Display all the information in compact format
                displayCompactInfo(selectedRoutes, user);
                displayRouteDetails(selectedRoutes);
                
                // Auto-open print dialog after content is loaded
                autoPrint();
                
            } catch (error) {
                console.error('Error loading print page data:', error);
                console.error('Error stack:', error.stack);
                document.querySelector('main').innerHTML = '<div class="user-assignment-info"><h4>Error</h4><p>Failed to load route data: ' + error.message + '</p></div>';
            }
        });
    </script>
</body>
</html>